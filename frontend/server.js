/**
 * Node.js ç”Ÿäº§ç¯å¢ƒæœåŠ¡å™¨ (Production Server)
 * -------------------------------------------------------------------------
 * è¿™æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ Express æœåŠ¡å™¨ï¼Œç”¨äºåœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ‰˜ç®¡æ„å»ºåçš„å‰ç«¯é™æ€æ–‡ä»¶ã€‚
 * 
 * ä¸»è¦åŠŸèƒ½:
 * 1. é™æ€èµ„æºæ‰˜ç®¡: å°† dist ç›®å½•ä½œä¸ºé™æ€èµ„æºæ ¹ç›®å½•ã€‚
 * 2. SPA è·¯ç”±æ”¯æŒ: å°†æ‰€æœ‰æœªåŒ¹é…çš„è·¯ç”±é‡å®šå‘åˆ° index.htmlï¼Œæ”¯æŒ Vue Router çš„ History æ¨¡å¼ã€‚
 * 
 * ä½¿ç”¨åœºæ™¯:
 * - è¿è¡Œ 'npm run build' ç”Ÿæˆ dist ç›®å½•åã€‚
 * - è¿è¡Œ 'npm start' å¯åŠ¨æ­¤æœåŠ¡å™¨é¢„è§ˆç”Ÿäº§ç¯å¢ƒæ•ˆæœã€‚
 */

import express from 'express';
import path from 'path';
import { fileURLToPath } from 'url';

// =========================================================================
// 1. ç¯å¢ƒé…ç½® (ES Modules å…¼å®¹)
// =========================================================================

// è·å– __dirname çš„æ›¿ä»£æ–¹æ¡ˆï¼ˆå› ä¸ºåœ¨ package.json type: module ä¸­æ— æ³•ç›´æ¥ä½¿ç”¨å…¨å±€ __dirnameï¼‰
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
// ä¼˜å…ˆä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„ PORTï¼Œå¦åˆ™é»˜è®¤ 3000
const PORT = process.env.PORT || 3000;

// =========================================================================
// 2. ä¸­é—´ä»¶é…ç½® (Middleware)
// =========================================================================

// æ‰˜ç®¡æ„å»ºåçš„é™æ€æ–‡ä»¶ (dist ç›®å½•)
// æµè§ˆå™¨è¯·æ±‚ /assets/xxx.js æ—¶ï¼Œä¼šç›´æ¥ä» dist/assets/xxx.js è¿”å›
app.use(express.static(path.join(__dirname, 'dist')));

// =========================================================================
// 3. è·¯ç”±å¤„ç† (Routing)
// =========================================================================

// å¤„ç† SPA (Single Page Application) è·¯ç”±
// æ•è·æ‰€æœ‰æœªè¢«é™æ€èµ„æºå¤„ç†çš„ GET è¯·æ±‚ï¼Œç»Ÿä¸€è¿”å› index.html
// è¿™æ ·å‰ç«¯è·¯ç”± (å¦‚ /chat, /settings) åˆ·æ–°æ—¶æ‰ä¸ä¼š 404
app.get('*', (req, res) => {
  res.sendFile(path.join(__dirname, 'dist', 'index.html'));
});

// =========================================================================
// 4. å¯åŠ¨æœåŠ¡ (Start Server)
// =========================================================================

app.listen(PORT, () => {
  console.log(`\nğŸš€ Server is running on: http://localhost:${PORT}`);
  console.log(`\næç¤ºï¼šè¯·ç¡®ä¿ä½ å·²ç»è¿è¡Œäº† 'npm run build' æ¥ç”Ÿæˆ dist ç›®å½•ã€‚\n`);
});
